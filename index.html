<!doctype html>
<html>
  <head></head>
  <body>
    <button onclick="read()" style="width:128px;height:30px;">Speak!</button>
    <hr/>
    <textarea rows="30" cols="60" id="presentation">
Hello everyone. 
My name is Liu Yao Yang.
I am five years old.
I am from Ta Pu Da Di Kindergarten, Class YaYa.
I have many tickets.
I want to buy a fish.
This is my aquarium.
There are two fish inside.
I like my fish very much.
I feed them everyday.
I like ABC Mouse very much.
I study English very hard.
Now a story for you.
Hats
I like hats.
It is cold.
I like my snow hat.
It is wet.
I like my rain hat.
It is hot.
I like my sun hat.
It is windy.
I like my cap.
We like hats.
That's all.
Thank you.
    </textarea>
    <script>
      let voices = window.speechSynthesis.getVoices()
      window.speechSynthesis.onvoiceschanged = function() {
        voices = window.speechSynthesis.getVoices()
      };

      const lines = []
      function read() {
        const presentation = document.getElementById('presentation').value.trim()
        for(const line of presentation.split('\n')) {
          lines.push(line.trim())
        }
        readLine()
      }

      const cache = []
      function readLine() {
        if(lines.length === 0) {
          return
        }
        const line = lines.shift()
        console.log(line)
        const msg = new SpeechSynthesisUtterance()
        msg.rate = 0.6
        msg.voice = voices.filter(voice => false
          || voice.name === 'Samantha'
          // || voice.name === 'Google US English'
          // || voice.name === 'Alex'
          // || voice.name === 'Fred'
          // || voice.name === 'Victoria'
        )[0]
        msg.text = line
        speechSynthesis.speak(msg)
        msg.onend = function() {
          readLine()
        }
        cache.push(msg) // avoid GC
        while(cache.length > 3) {
          cache.shift()
        }
      }
    </script>
  </body>
</html>
